apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-init-db
  namespace: default
spec:
  template:
    spec:
      containers:
      - name: init-db
        image: postgres:15-alpine
        env:
        - name: PGPASSWORD
          value: "orderpass123"
        command:
        - /bin/sh
        - -c
        - |
          until pg_isready -h postgres -p 5432 -U orderuser; do
            echo "Waiting for postgres..."
            sleep 2
          done
          
          psql -h postgres -U orderuser -d orders -c "
          CREATE TABLE IF NOT EXISTS orders (
            order_id VARCHAR(255) PRIMARY KEY,
            user_id VARCHAR(255),
            email VARCHAR(255),
            items JSONB,
            total_amount DECIMAL(10,2),
            currency VARCHAR(10),
            shipping_address JSONB,
            payment_method VARCHAR(50),
            order_status VARCHAR(50) DEFAULT 'pending',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          
          CREATE INDEX IF NOT EXISTS idx_user_id ON orders(user_id);
          CREATE INDEX IF NOT EXISTS idx_created_at ON orders(created_at);
          CREATE INDEX IF NOT EXISTS idx_order_status ON orders(order_status);
          
          -- Create a view for order analytics
          CREATE OR REPLACE VIEW order_analytics AS
          SELECT 
            DATE(created_at) as order_date,
            COUNT(*) as total_orders,
            SUM(total_amount) as total_revenue,
            AVG(total_amount) as avg_order_value,
            order_status,
            currency
          FROM orders
          GROUP BY DATE(created_at), order_status, currency;
          
          -- Insert sample data for testing
          INSERT INTO orders (order_id, user_id, email, items, total_amount, currency, shipping_address, payment_method, order_status)
          VALUES 
            ('ORD-001', 'user-123', 'test@example.com', 
             '[{\"product\": \"Vintage Camera Lens\", \"quantity\": 1, \"price\": 79.99}]'::jsonb,
             79.99, 'USD',
             '{\"street\": \"123 Main St\", \"city\": \"Springfield\", \"zip\": \"12345\"}'::jsonb,
             'credit_card', 'completed'),
            ('ORD-002', 'user-456', 'demo@example.com',
             '[{\"product\": \"Vintage Typewriter\", \"quantity\": 2, \"price\": 149.99}]'::jsonb,
             299.98, 'USD',
             '{\"street\": \"456 Oak Ave\", \"city\": \"Portland\", \"zip\": \"97201\"}'::jsonb,
             'paypal', 'pending')
          ON CONFLICT (order_id) DO NOTHING;
          "
          
          echo "âœ… Database initialized successfully!"
          echo "ðŸ“Š Sample orders created for testing"
      restartPolicy: Never
  backoffLimit: 3
